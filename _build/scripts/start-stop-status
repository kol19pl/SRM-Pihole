#!/bin/sh


# Ustawienia podstawowe
if [ -z "$SYNOPKG_PKGNAME" ]; then
    PACKAGE_NAME="pi-hole"
    PACKAGE_VER=$(get_key_value "/var/packages/${PACKAGE_NAME}/INFO" "version")
else
    PACKAGE_NAME=$SYNOPKG_PKGNAME
    PACKAGE_VER=$SYNOPKG_PKGVER
fi

# Ścieżki
SCRIPTSPATH="/var/packages/${PACKAGE_NAME}/target/scripts"
APP_PATH="/usr/syno/synoman/webman/3rdparty/$PACKAGE_NAME"
PACKAGE_DIR="/var/packages/${PACKAGE_NAME}"
PACKAGE_ENABLED="/var/packages/${PACKAGE_NAME}/etc/package.cfg"
LOG_FILE="/var/log/pi-hole.log"
SYNO_SERVICE_TOOL="/usr/syno/sbin/synoservice"

# Pobranie wersji DSM
dsm_get_version() {
    local version_file="/etc.defaults/VERSION"
    [ -f "$version_file" ] || { echo "Brak pliku wersji DSM"; return 1; }
    grep -s ^buildnumber ${version_file} | head -1 | awk -F '"' '{print $2}' | tr -d ' '
}
DSM_BUILD_NUM=$(dsm_get_version)
AUTH_API_MIN_SUPPORT=2239

# Funkcja startowa
start() {
    echo "$(date) - Uruchamianie Pi-hole..." >> $LOG_FILE
    $SYNO_SERVICE_TOOL --start pi-hole
}

# Funkcja stop
stop() {
    echo "$(date) - Zatrzymywanie Pi-hole..." >> $LOG_FILE
    $SYNO_SERVICE_TOOL --stop pi-hole
}

# Funkcja killall
killall() {
    echo "$(date) - Zabijanie wszystkich procesów Pi-hole..." >> $LOG_FILE
    pkill -f pihole-FTL
}

# Główna obsługa przypadków
case $1 in
    start)
        if [ ! -f $PACKAGE_ENABLED ]; then
            exit 0
        fi
        start
        exit 0
    ;;
    stop)
        stop
        exit 0
    ;;
    status)
        [ -e ${APP_PATH} ] && exit 0 || exit 1
    ;;
    killall)
        killall
        exit 0
    ;;
    log)
        tail -f $LOG_FILE
    ;;
    *)
        echo "Użycie: $0 {start|stop|status|killall|log}"
        exit 1
    ;;
esac

